window.ikiToolkit = window.ikiToolkit || {};
window.ikiToolkit.admin = window.ikiToolkit.admin || {};
window.ikiToolkit.admin.ExternalApiValidator = (function ($) {

    "use strict";

    return {

        testFlickr: testFlickr,
        testDribbble: testDribbble,
        testPinterest: testPinterest,
        testFiveHundred: testFiveHundred,
        sendRequest: sendRequest,
        init: init,
        setNonce: setNonce,
        _sendRequest: sendRequest

    };


    function init() {

        this.defaultData = {
            flickr: '81703997@N00',
            pinterest: '',
            'fiveHundred': 'ikixxx',
            'dribbble': 'fantasy'
        };
        return this;
    }

    function setNonce(nonce) {
        this.nonce = nonce;
    }

    function testFlickr(username, photoset, apiKey, keyOnly) {

        if (keyOnly) {
            username = (username.trim()) ? username : this.defaultData.flickr;
        }

        var action = 'iki_check_external_data';
        var method = 'get_user';

        var d = {
            action: action,
            method: method,
            service: 'flickr',
            data: {
                'user_id': username,
                'cache': 'disabled'
            }
        };

        if (apiKey) {
            d.data.api_key = apiKey;
        }
        if (photoset.trim()) {
            d.method = 'get_photoset_info';
            d.data.photoset_id = photoset;
        }

        return this._sendRequest(d);
    }

    function testDribbble(username, apiKey, keyOnly) {

        if (keyOnly) {
            username = (username.trim()) ? username : this.defaultData.dribbble;
        }

        var action = 'iki_check_external_data';
        var method = 'get_user';

        var d = {
            action: action,
            method: method,
            service: 'dribbble',
            data: {
                'username': username,
                'cache': 'disabled'
            }
        };
        if (apiKey) {
            d.data.api_key = apiKey;
        }
        return this._sendRequest(d);
    }

    function testPinterest(username, board) {

        username = (username.trim()) ? username : this.defaultData.pinterest;

        var action = 'iki_check_external_data';
        var method = 'get_user_latest_pins';

        var d = {
            action: action,
            method: method,
            service: 'pinterest',
            data: {
                'user': username,
                'cache': 'disabled'
            }
        };

        if (board.trim()) {
            d.method = 'get_user_board';
            d.data.boardname = board;
        }

        return this._sendRequest(d);
    }

    function testFiveHundred(username, gallery, apiKey, keyOnly) {

        if (keyOnly) {
            username = (username.trim()) ? username : this.defaultData.fiveHundred;
        }

        var action = 'iki_check_external_data';
        var method = 'get_user';

        var d = {
            action: action,
            method: method,
            service: '500px',
            data: {
                'username': username,
                'cache': 'disabled'
            }
        };

        if (gallery.trim()) {
            d.method = 'get_user_gallery';
            d.data.gallery = gallery;
        }

        if (apiKey) {
            d.data.api_key = apiKey;
        }
        return this._sendRequest(d);
    }

    function sendRequest(data) {


        data._ajax_nonce = this.nonce;

        console.log("data");
        console.dir(data);
        var deferred = $.Deferred();
        $.ajax({
            type: 'POST',
            url: ajaxurl,
            dataType: 'json',
            timeout: 10000,
            data: data
        }).done(function (data, status, xhr) {

            if (0 === data) {

                deferred.reject(data);

            } else {

                data = JSON.parse(data);

                if ('failure' === data.status) {
                    deferred.reject(data);
                }
                else {
                    deferred.resolve(data);
                }
            }


        }).fail(function (data, status, xhr) {
            try {
                data = JSON.parse(data);
            } catch (e) {

            }
            deferred.reject(data, status, xhr);
        });

        return deferred.promise();
    }
}(jQuery));

jQuery(document).ready(function ($) {

    "use strict";
    var extValidator = Object.create(window.ikiToolkit.admin.ExternalApiValidator).init();
    // flickr api test
    var ajaxNonce = $('#iki-ajax-nonce').data('ikiNonce');
    extValidator.setNonce(ajaxNonce);

    var $flickrInput = $('#iki-flickr_api_key');
    var $flickrUI = $('#iki-test-flickr-api');

    var $flickrTestBtn = $flickrUI.children('.button');
    var $flickrSpinner = $flickrUI.children('.spinner');
    var $flickrSuccessField = $flickrUI.children('.updated');
    var $flickrErrorField = $flickrUI.children('.error');

    $flickrTestBtn.on('click', function (e) {

        e.preventDefault();
        $flickrTestBtn.prop('disabled', true);

        $flickrSuccessField.hide();
        $flickrErrorField.hide();

        var apiValue = $flickrInput.val();
        apiValue = (apiValue.trim()) ? apiValue : 'fake_key_force_error';
        var response = extValidator.testFlickr('', '', apiValue, true);

        response.always(function () {
            $flickrTestBtn.prop('disabled', false);
        });

        handleResponse(response, $flickrSpinner, $flickrSuccessField, $flickrErrorField);
    });

    /*DRIBBBLE TEST*/
    var $dribbbleInput = $('#iki-dribbble_api_key');
    var $dribbbleUI = $('#iki-test-dribbble-api');

    var $dribbbleTestBtn = $dribbbleUI.children('.button');
    var $dribbbleSpinner = $dribbbleUI.children('.spinner');
    var $dribbbleSuccessField = $dribbbleUI.children('.updated');
    var $dribbbleErrorField = $dribbbleUI.children('.error');

    $dribbbleTestBtn.on('click', function (e) {

        e.preventDefault();

        $dribbbleTestBtn.prop('disabled', true);

        $dribbbleSuccessField.hide();
        $dribbbleErrorField.hide();

        var apiValue = $dribbbleInput.val();
        apiValue = (apiValue.trim()) ? apiValue : 'fake_key_force_error';

        var response = extValidator.testDribbble('', apiValue, true);

        response.always(function () {
            $dribbbleTestBtn.prop('disabled', false);
        });

        handleResponse(response, $dribbbleSpinner, $dribbbleSuccessField, $dribbbleErrorField);
    });


    /*FIVEHUNDRED PX TEST*/
    var $fiveInput = $('#iki-500px_api_key');
    var $fiveUI = $('#iki-test-five-api');

    var $fiveTestBtn = $fiveUI.children('.button');
    var $fiveSpinner = $fiveUI.children('.spinner');
    var $fiveSuccessField = $fiveUI.children('.updated');
    var $fiveErrorField = $fiveUI.children('.error');

    $fiveTestBtn.on('click', function (e) {

        e.preventDefault();

        $fiveTestBtn.prop('disabled', true);

        $fiveSuccessField.hide();
        $fiveErrorField.hide();

        var apiValue = $fiveInput.val();
        apiValue = (apiValue.trim()) ? apiValue : 'fake_key_force_error';

        var response = extValidator.testFiveHundred('', '', apiValue, true);

        response.always(function () {
            $fiveTestBtn.prop('disabled', false);
        });

        handleResponse(response, $fiveSpinner, $fiveSuccessField, $fiveErrorField);
    });

    function handleResponse(response, $spinner, $successField, $errorField) {

        $spinner.css('visibility', 'visible');

        response.done(function (data) {

            $successField.show();
            $successField.text($spinner.data('ikiSuccess'));

        }).fail(function (data) {
            console.log("fail data");
            console.dir(data);
            if (data.statusText && 'timeout' === data.statusText) {

                $errorField.text($spinner.data('ikiTimeout'));

            } else {

                $errorField.text($spinner.data('ikiFailure'));
            }

            $successField.text('');
            $errorField.show();

        }).always(function () {
            $spinner.css('visibility', 'hidden');
        });

    }


});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dC12YWxpZGF0b3IuanMiLCJleHRlcm5hbC1hcGktdGVzdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYWRtaW4tc2V0dGluZ3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ3aW5kb3cuaWtpVG9vbGtpdCA9IHdpbmRvdy5pa2lUb29sa2l0IHx8IHt9O1xud2luZG93LmlraVRvb2xraXQuYWRtaW4gPSB3aW5kb3cuaWtpVG9vbGtpdC5hZG1pbiB8fCB7fTtcbndpbmRvdy5pa2lUb29sa2l0LmFkbWluLkV4dGVybmFsQXBpVmFsaWRhdG9yID0gKGZ1bmN0aW9uICgkKSB7XG5cbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIHJldHVybiB7XG5cbiAgICAgICAgdGVzdEZsaWNrcjogdGVzdEZsaWNrcixcbiAgICAgICAgdGVzdERyaWJiYmxlOiB0ZXN0RHJpYmJibGUsXG4gICAgICAgIHRlc3RQaW50ZXJlc3Q6IHRlc3RQaW50ZXJlc3QsXG4gICAgICAgIHRlc3RGaXZlSHVuZHJlZDogdGVzdEZpdmVIdW5kcmVkLFxuICAgICAgICBzZW5kUmVxdWVzdDogc2VuZFJlcXVlc3QsXG4gICAgICAgIGluaXQ6IGluaXQsXG4gICAgICAgIHNldE5vbmNlOiBzZXROb25jZSxcbiAgICAgICAgX3NlbmRSZXF1ZXN0OiBzZW5kUmVxdWVzdFxuXG4gICAgfTtcblxuXG4gICAgZnVuY3Rpb24gaW5pdCgpIHtcblxuICAgICAgICB0aGlzLmRlZmF1bHREYXRhID0ge1xuICAgICAgICAgICAgZmxpY2tyOiAnODE3MDM5OTdATjAwJyxcbiAgICAgICAgICAgIHBpbnRlcmVzdDogJycsXG4gICAgICAgICAgICAnZml2ZUh1bmRyZWQnOiAnaWtpeHh4JyxcbiAgICAgICAgICAgICdkcmliYmJsZSc6ICdmYW50YXN5J1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXROb25jZShub25jZSkge1xuICAgICAgICB0aGlzLm5vbmNlID0gbm9uY2U7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdGVzdEZsaWNrcih1c2VybmFtZSwgcGhvdG9zZXQsIGFwaUtleSwga2V5T25seSkge1xuXG4gICAgICAgIGlmIChrZXlPbmx5KSB7XG4gICAgICAgICAgICB1c2VybmFtZSA9ICh1c2VybmFtZS50cmltKCkpID8gdXNlcm5hbWUgOiB0aGlzLmRlZmF1bHREYXRhLmZsaWNrcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBhY3Rpb24gPSAnaWtpX2NoZWNrX2V4dGVybmFsX2RhdGEnO1xuICAgICAgICB2YXIgbWV0aG9kID0gJ2dldF91c2VyJztcblxuICAgICAgICB2YXIgZCA9IHtcbiAgICAgICAgICAgIGFjdGlvbjogYWN0aW9uLFxuICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgICBzZXJ2aWNlOiAnZmxpY2tyJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAndXNlcl9pZCc6IHVzZXJuYW1lLFxuICAgICAgICAgICAgICAgICdjYWNoZSc6ICdkaXNhYmxlZCdcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoYXBpS2V5KSB7XG4gICAgICAgICAgICBkLmRhdGEuYXBpX2tleSA9IGFwaUtleTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGhvdG9zZXQudHJpbSgpKSB7XG4gICAgICAgICAgICBkLm1ldGhvZCA9ICdnZXRfcGhvdG9zZXRfaW5mbyc7XG4gICAgICAgICAgICBkLmRhdGEucGhvdG9zZXRfaWQgPSBwaG90b3NldDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9zZW5kUmVxdWVzdChkKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiB0ZXN0RHJpYmJibGUodXNlcm5hbWUsIGFwaUtleSwga2V5T25seSkge1xuXG4gICAgICAgIGlmIChrZXlPbmx5KSB7XG4gICAgICAgICAgICB1c2VybmFtZSA9ICh1c2VybmFtZS50cmltKCkpID8gdXNlcm5hbWUgOiB0aGlzLmRlZmF1bHREYXRhLmRyaWJiYmxlO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGFjdGlvbiA9ICdpa2lfY2hlY2tfZXh0ZXJuYWxfZGF0YSc7XG4gICAgICAgIHZhciBtZXRob2QgPSAnZ2V0X3VzZXInO1xuXG4gICAgICAgIHZhciBkID0ge1xuICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sXG4gICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgICAgICAgIHNlcnZpY2U6ICdkcmliYmJsZScsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgJ3VzZXJuYW1lJzogdXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgJ2NhY2hlJzogJ2Rpc2FibGVkJ1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBpZiAoYXBpS2V5KSB7XG4gICAgICAgICAgICBkLmRhdGEuYXBpX2tleSA9IGFwaUtleTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZFJlcXVlc3QoZCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdGVzdFBpbnRlcmVzdCh1c2VybmFtZSwgYm9hcmQpIHtcblxuICAgICAgICB1c2VybmFtZSA9ICh1c2VybmFtZS50cmltKCkpID8gdXNlcm5hbWUgOiB0aGlzLmRlZmF1bHREYXRhLnBpbnRlcmVzdDtcblxuICAgICAgICB2YXIgYWN0aW9uID0gJ2lraV9jaGVja19leHRlcm5hbF9kYXRhJztcbiAgICAgICAgdmFyIG1ldGhvZCA9ICdnZXRfdXNlcl9sYXRlc3RfcGlucyc7XG5cbiAgICAgICAgdmFyIGQgPSB7XG4gICAgICAgICAgICBhY3Rpb246IGFjdGlvbixcbiAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgICAgICAgc2VydmljZTogJ3BpbnRlcmVzdCcsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgJ3VzZXInOiB1c2VybmFtZSxcbiAgICAgICAgICAgICAgICAnY2FjaGUnOiAnZGlzYWJsZWQnXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGJvYXJkLnRyaW0oKSkge1xuICAgICAgICAgICAgZC5tZXRob2QgPSAnZ2V0X3VzZXJfYm9hcmQnO1xuICAgICAgICAgICAgZC5kYXRhLmJvYXJkbmFtZSA9IGJvYXJkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbmRSZXF1ZXN0KGQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHRlc3RGaXZlSHVuZHJlZCh1c2VybmFtZSwgZ2FsbGVyeSwgYXBpS2V5LCBrZXlPbmx5KSB7XG5cbiAgICAgICAgaWYgKGtleU9ubHkpIHtcbiAgICAgICAgICAgIHVzZXJuYW1lID0gKHVzZXJuYW1lLnRyaW0oKSkgPyB1c2VybmFtZSA6IHRoaXMuZGVmYXVsdERhdGEuZml2ZUh1bmRyZWQ7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgYWN0aW9uID0gJ2lraV9jaGVja19leHRlcm5hbF9kYXRhJztcbiAgICAgICAgdmFyIG1ldGhvZCA9ICdnZXRfdXNlcic7XG5cbiAgICAgICAgdmFyIGQgPSB7XG4gICAgICAgICAgICBhY3Rpb246IGFjdGlvbixcbiAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgICAgICAgc2VydmljZTogJzUwMHB4JyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAndXNlcm5hbWUnOiB1c2VybmFtZSxcbiAgICAgICAgICAgICAgICAnY2FjaGUnOiAnZGlzYWJsZWQnXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGdhbGxlcnkudHJpbSgpKSB7XG4gICAgICAgICAgICBkLm1ldGhvZCA9ICdnZXRfdXNlcl9nYWxsZXJ5JztcbiAgICAgICAgICAgIGQuZGF0YS5nYWxsZXJ5ID0gZ2FsbGVyeTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlLZXkpIHtcbiAgICAgICAgICAgIGQuZGF0YS5hcGlfa2V5ID0gYXBpS2V5O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9zZW5kUmVxdWVzdChkKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZW5kUmVxdWVzdChkYXRhKSB7XG5cblxuICAgICAgICBkYXRhLl9hamF4X25vbmNlID0gdGhpcy5ub25jZTtcblxuICAgICAgICBjb25zb2xlLmxvZyhcImRhdGFcIik7XG4gICAgICAgIGNvbnNvbGUuZGlyKGRhdGEpO1xuICAgICAgICB2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7XG4gICAgICAgICQuYWpheCh7XG4gICAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgICB1cmw6IGFqYXh1cmwsXG4gICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxuICAgICAgICAgICAgdGltZW91dDogMTAwMDAsXG4gICAgICAgICAgICBkYXRhOiBkYXRhXG4gICAgICAgIH0pLmRvbmUoZnVuY3Rpb24gKGRhdGEsIHN0YXR1cywgeGhyKSB7XG5cbiAgICAgICAgICAgIGlmICgwID09PSBkYXRhKSB7XG5cbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZGF0YSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShkYXRhKTtcblxuICAgICAgICAgICAgICAgIGlmICgnZmFpbHVyZScgPT09IGRhdGEuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChkYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgfSkuZmFpbChmdW5jdGlvbiAoZGF0YSwgc3RhdHVzLCB4aHIpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChkYXRhLCBzdGF0dXMsIHhocik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7XG4gICAgfVxufShqUXVlcnkpKTtcbiIsImpRdWVyeShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCQpIHtcblxuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIHZhciBleHRWYWxpZGF0b3IgPSBPYmplY3QuY3JlYXRlKHdpbmRvdy5pa2lUb29sa2l0LmFkbWluLkV4dGVybmFsQXBpVmFsaWRhdG9yKS5pbml0KCk7XG4gICAgLy8gZmxpY2tyIGFwaSB0ZXN0XG4gICAgdmFyIGFqYXhOb25jZSA9ICQoJyNpa2ktYWpheC1ub25jZScpLmRhdGEoJ2lraU5vbmNlJyk7XG4gICAgZXh0VmFsaWRhdG9yLnNldE5vbmNlKGFqYXhOb25jZSk7XG5cbiAgICB2YXIgJGZsaWNrcklucHV0ID0gJCgnI2lraS1mbGlja3JfYXBpX2tleScpO1xuICAgIHZhciAkZmxpY2tyVUkgPSAkKCcjaWtpLXRlc3QtZmxpY2tyLWFwaScpO1xuXG4gICAgdmFyICRmbGlja3JUZXN0QnRuID0gJGZsaWNrclVJLmNoaWxkcmVuKCcuYnV0dG9uJyk7XG4gICAgdmFyICRmbGlja3JTcGlubmVyID0gJGZsaWNrclVJLmNoaWxkcmVuKCcuc3Bpbm5lcicpO1xuICAgIHZhciAkZmxpY2tyU3VjY2Vzc0ZpZWxkID0gJGZsaWNrclVJLmNoaWxkcmVuKCcudXBkYXRlZCcpO1xuICAgIHZhciAkZmxpY2tyRXJyb3JGaWVsZCA9ICRmbGlja3JVSS5jaGlsZHJlbignLmVycm9yJyk7XG5cbiAgICAkZmxpY2tyVGVzdEJ0bi5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgJGZsaWNrclRlc3RCdG4ucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcblxuICAgICAgICAkZmxpY2tyU3VjY2Vzc0ZpZWxkLmhpZGUoKTtcbiAgICAgICAgJGZsaWNrckVycm9yRmllbGQuaGlkZSgpO1xuXG4gICAgICAgIHZhciBhcGlWYWx1ZSA9ICRmbGlja3JJbnB1dC52YWwoKTtcbiAgICAgICAgYXBpVmFsdWUgPSAoYXBpVmFsdWUudHJpbSgpKSA/IGFwaVZhbHVlIDogJ2Zha2Vfa2V5X2ZvcmNlX2Vycm9yJztcbiAgICAgICAgdmFyIHJlc3BvbnNlID0gZXh0VmFsaWRhdG9yLnRlc3RGbGlja3IoJycsICcnLCBhcGlWYWx1ZSwgdHJ1ZSk7XG5cbiAgICAgICAgcmVzcG9uc2UuYWx3YXlzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICRmbGlja3JUZXN0QnRuLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBoYW5kbGVSZXNwb25zZShyZXNwb25zZSwgJGZsaWNrclNwaW5uZXIsICRmbGlja3JTdWNjZXNzRmllbGQsICRmbGlja3JFcnJvckZpZWxkKTtcbiAgICB9KTtcblxuICAgIC8qRFJJQkJCTEUgVEVTVCovXG4gICAgdmFyICRkcmliYmJsZUlucHV0ID0gJCgnI2lraS1kcmliYmJsZV9hcGlfa2V5Jyk7XG4gICAgdmFyICRkcmliYmJsZVVJID0gJCgnI2lraS10ZXN0LWRyaWJiYmxlLWFwaScpO1xuXG4gICAgdmFyICRkcmliYmJsZVRlc3RCdG4gPSAkZHJpYmJibGVVSS5jaGlsZHJlbignLmJ1dHRvbicpO1xuICAgIHZhciAkZHJpYmJibGVTcGlubmVyID0gJGRyaWJiYmxlVUkuY2hpbGRyZW4oJy5zcGlubmVyJyk7XG4gICAgdmFyICRkcmliYmJsZVN1Y2Nlc3NGaWVsZCA9ICRkcmliYmJsZVVJLmNoaWxkcmVuKCcudXBkYXRlZCcpO1xuICAgIHZhciAkZHJpYmJibGVFcnJvckZpZWxkID0gJGRyaWJiYmxlVUkuY2hpbGRyZW4oJy5lcnJvcicpO1xuXG4gICAgJGRyaWJiYmxlVGVzdEJ0bi5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAkZHJpYmJibGVUZXN0QnRuLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XG5cbiAgICAgICAgJGRyaWJiYmxlU3VjY2Vzc0ZpZWxkLmhpZGUoKTtcbiAgICAgICAgJGRyaWJiYmxlRXJyb3JGaWVsZC5oaWRlKCk7XG5cbiAgICAgICAgdmFyIGFwaVZhbHVlID0gJGRyaWJiYmxlSW5wdXQudmFsKCk7XG4gICAgICAgIGFwaVZhbHVlID0gKGFwaVZhbHVlLnRyaW0oKSkgPyBhcGlWYWx1ZSA6ICdmYWtlX2tleV9mb3JjZV9lcnJvcic7XG5cbiAgICAgICAgdmFyIHJlc3BvbnNlID0gZXh0VmFsaWRhdG9yLnRlc3REcmliYmJsZSgnJywgYXBpVmFsdWUsIHRydWUpO1xuXG4gICAgICAgIHJlc3BvbnNlLmFsd2F5cyhmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkZHJpYmJibGVUZXN0QnRuLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICBoYW5kbGVSZXNwb25zZShyZXNwb25zZSwgJGRyaWJiYmxlU3Bpbm5lciwgJGRyaWJiYmxlU3VjY2Vzc0ZpZWxkLCAkZHJpYmJibGVFcnJvckZpZWxkKTtcbiAgICB9KTtcblxuXG4gICAgLypGSVZFSFVORFJFRCBQWCBURVNUKi9cbiAgICB2YXIgJGZpdmVJbnB1dCA9ICQoJyNpa2ktNTAwcHhfYXBpX2tleScpO1xuICAgIHZhciAkZml2ZVVJID0gJCgnI2lraS10ZXN0LWZpdmUtYXBpJyk7XG5cbiAgICB2YXIgJGZpdmVUZXN0QnRuID0gJGZpdmVVSS5jaGlsZHJlbignLmJ1dHRvbicpO1xuICAgIHZhciAkZml2ZVNwaW5uZXIgPSAkZml2ZVVJLmNoaWxkcmVuKCcuc3Bpbm5lcicpO1xuICAgIHZhciAkZml2ZVN1Y2Nlc3NGaWVsZCA9ICRmaXZlVUkuY2hpbGRyZW4oJy51cGRhdGVkJyk7XG4gICAgdmFyICRmaXZlRXJyb3JGaWVsZCA9ICRmaXZlVUkuY2hpbGRyZW4oJy5lcnJvcicpO1xuXG4gICAgJGZpdmVUZXN0QnRuLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7XG5cbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICRmaXZlVGVzdEJ0bi5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xuXG4gICAgICAgICRmaXZlU3VjY2Vzc0ZpZWxkLmhpZGUoKTtcbiAgICAgICAgJGZpdmVFcnJvckZpZWxkLmhpZGUoKTtcblxuICAgICAgICB2YXIgYXBpVmFsdWUgPSAkZml2ZUlucHV0LnZhbCgpO1xuICAgICAgICBhcGlWYWx1ZSA9IChhcGlWYWx1ZS50cmltKCkpID8gYXBpVmFsdWUgOiAnZmFrZV9rZXlfZm9yY2VfZXJyb3InO1xuXG4gICAgICAgIHZhciByZXNwb25zZSA9IGV4dFZhbGlkYXRvci50ZXN0Rml2ZUh1bmRyZWQoJycsICcnLCBhcGlWYWx1ZSwgdHJ1ZSk7XG5cbiAgICAgICAgcmVzcG9uc2UuYWx3YXlzKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICRmaXZlVGVzdEJ0bi5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaGFuZGxlUmVzcG9uc2UocmVzcG9uc2UsICRmaXZlU3Bpbm5lciwgJGZpdmVTdWNjZXNzRmllbGQsICRmaXZlRXJyb3JGaWVsZCk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBoYW5kbGVSZXNwb25zZShyZXNwb25zZSwgJHNwaW5uZXIsICRzdWNjZXNzRmllbGQsICRlcnJvckZpZWxkKSB7XG5cbiAgICAgICAgJHNwaW5uZXIuY3NzKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTtcblxuICAgICAgICByZXNwb25zZS5kb25lKGZ1bmN0aW9uIChkYXRhKSB7XG5cbiAgICAgICAgICAgICRzdWNjZXNzRmllbGQuc2hvdygpO1xuICAgICAgICAgICAgJHN1Y2Nlc3NGaWVsZC50ZXh0KCRzcGlubmVyLmRhdGEoJ2lraVN1Y2Nlc3MnKSk7XG5cbiAgICAgICAgfSkuZmFpbChmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJmYWlsIGRhdGFcIik7XG4gICAgICAgICAgICBjb25zb2xlLmRpcihkYXRhKTtcbiAgICAgICAgICAgIGlmIChkYXRhLnN0YXR1c1RleHQgJiYgJ3RpbWVvdXQnID09PSBkYXRhLnN0YXR1c1RleHQpIHtcblxuICAgICAgICAgICAgICAgICRlcnJvckZpZWxkLnRleHQoJHNwaW5uZXIuZGF0YSgnaWtpVGltZW91dCcpKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICRlcnJvckZpZWxkLnRleHQoJHNwaW5uZXIuZGF0YSgnaWtpRmFpbHVyZScpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgJHN1Y2Nlc3NGaWVsZC50ZXh0KCcnKTtcbiAgICAgICAgICAgICRlcnJvckZpZWxkLnNob3coKTtcblxuICAgICAgICB9KS5hbHdheXMoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJHNwaW5uZXIuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICAgICAgICB9KTtcblxuICAgIH1cblxuXG59KTtcbiJdfQ==
